{% extends "base.html" %}

{% load static %}
{% load my_filters %}

{% block metrika %}{% include "metric.html" %}{% endblock %}

{% block title %}Купить билет на {{ concert.title }}{% endblock %}

{% block description %}
    Купить билет на концерт {{ concert.title }}.
    {{ concert.description }}
{% endblock %}

{% block body %}
    <div class="container" id="app">
        <div v-if="data_loading" class="d-flex justify-content-center align-middle my-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <div v-if="!data_loading && prices">
            <div class="p-3 mb-3">

                <h2>Билет на концерт - [[ concert.title ]]</h2>
                <p>[[ concert.date_time ]]</p>

                <div v-if="prices.length == 0">
                    <div class="alert alert-info" role="alert">
                        К сожалению, билеты закончились.
                    </div>

                    <div v-if="error" class="alert alert-danger" role="alert">
                        [[ error ]]
                    </div>
                </div>

                <div v-if="prices.length != 0">
                    <div v-if="concert.buy_ticket_message" class="alert alert-info" role="alert">
                        [[ concert.buy_ticket_message ]]
                    </div>

                    <div class="form-floating mb-3" :class="{'shadow': nameFocused}">
                        <input id="floatingInputn" type="text" class="form-control" v-model="name"
                               @focus="nameFocused = true" @blur="nameFocused = false" required
                               :class="{'is-invalid': nameInvalid}">
                        <label for="floatingInputn">Имя и Фамилия</label>
                    </div>

                    <div class="form-floating mb-3" :class="{'shadow': emailFocused}">
                        <input type="email" class="form-control" id="floatingInpute" v-model="email" required
                               @focus="emailFocused = true" @blur="emailFocused = false"
                               :class="{'is-invalid': emailInvalid}">
                        <label for="floatingInpute">Электронная почта</label>
                    </div>

                    <div class="form-floating mb-3" :class="{'shadow': phoneFocused}">
                        <input maxlength="18" type="tel" @keydown="onPhoneKeyDown" @input="onPhoneInput"
                               @paste="onPhonePaste" @focus="phoneFocused = true" @blur="phoneFocused = false"
                               class="form-control" id="id_phone_number" v-model="phone" required
                               :class="{'is-invalid': phoneInvalid}"/>
                        <label for="id_phone_number">Номер телефона</label>
                    </div>

                    <div class="row">
                        <div v-for="(price, index) in prices" :key="price.id">
                            <div class="col">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6 class="card-subtitle mb-2 text-muted">[[ price.description ]]</h6>
                                        <p class="card-text">[[ formatPrice(price.price) ]] [[
                                            price.currency ]]</p>
                                        <div class="row mb-3">
                                            <div class="row">
                                                <div class="col text-end">
                                                    <button type="button" class="btn btn-secondary"
                                                            @click="decrementPrice(index);">-
                                                    </button>
                                                </div>
                                                <div class="col">
                                                    <input class="form-control rounded" type="text"
                                                           v-model="price.count" :key="index"/>
                                                </div>
                                                <div class="col">
                                                    <button type="button" class="btn btn-secondary"
                                                            @click="incrementPrice(index);">+
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="amount" class="card">
                        <div class="card-body">
                            Сумма: [[ amount ]] руб.
                        </div>
                    </div>

                    <div v-if="amountInvalid && !amount" class="alert alert-danger" role="alert">
                        Добавьте хотя бы один билет.
                    </div>

                    <div v-if="error" class="alert alert-info" role="alert">
                        [[ error ]]
                    </div>

                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-outline-secondary btn-lg" type="button" @click="submitForm">
                        <span v-if="pay_loading" class="spinner-border spinner-border-sm text-secondary" role="status"
                              aria-hidden="true"></span>
                            Оплатить
                        </button>
                    </div>

                    <form method="POST" action="https://yoomoney.ru/quickpay/confirm.xml">
                        <input type="hidden" name="successURL"
                               :value="'https://mountainteaband.ru/concerts/tickets/donepayment/?t=' + transaction_id"/>
                        <input type="hidden" name="receiver" :value="concert.yandex_wallet_receiver"/>
                        <input type="hidden" name="formcomment" :value="'Горный Чай: ' + concert.title"/>
                        <input type="hidden" name="short-dest" :value="'Горный Чай: ' + concert.title"/>
                        <input type="hidden" name="label" :value="transaction_id"/>
                        <input type="hidden" name="quickpay-form" value="shop"/>
                        <input type="hidden" name="targets" :value="'Горный Чай: ' + concert.title"/>
                        <input type="hidden" name="sum" :value="amount" data-type="number"/>
                        <input type="hidden" name="paymentType" value="AC"/>
                        <button ref="submit" style="display:none;" type="submit"></button>
                    </form>

                </div>
            </div>
        </div>

        {% include "footer.html" %}
    </div>
{% endblock %}

{% block script %}
    <script src="{% static 'js/buy_ticket.js' %}"></script>
{% endblock %}
